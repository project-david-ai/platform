%%{init: {
  "theme": "base",
  "themeVariables": {
    "background": "#f8f9fc",
    "primaryColor": "#dbeafe",
    "primaryTextColor": "#1e3a5f",
    "primaryBorderColor": "#3b82f6",
    "secondaryColor": "#fef3c7",
    "secondaryTextColor": "#78350f",
    "secondaryBorderColor": "#f59e0b",
    "tertiaryColor": "#ede9fe",
    "tertiaryTextColor": "#4c1d95",
    "tertiaryBorderColor": "#7c3aed",
    "nodeTextColor": "#1e293b",
    "edgeLabelBackground": "#f1f5f9",
    "clusterBkg": "#f8faff",
    "clusterBorder": "#cbd5e1",
    "titleColor": "#1e293b",
    "lineColor": "#94a3b8",
    "fontSize": "18px",
    "fontFamily": "Georgia, serif"
  }
}}%%
graph TD
    Developer([Your Application\nor Reference Implementation])

    subgraph DavidCore ["david-core — Cloud Orchestration Layer"]
        direction TB
        Proxy[nginx-proxy\nTLS Termination]
        ACME[acme-companion\nLet's Encrypt]
        Landing[open.projectdavid.co.uk\nLanding Page]
        Docs[docs.projectdavid.co.uk\nDocumentation]
    end

    subgraph SDK ["projectdavid — Python SDK"]
        direction TB
        EntityClient[Entity Client\nAssistants · Threads · Runs · Messages]
        SyncStream[SynchronousInferenceStream\nEvent Mapping · Tool Validation]
        Common[projectdavid_common\nValidation · Schemas · Utilities]
    end

    subgraph Platform ["platform — Core Orchestration Engine"]
        direction TB
        FastAPI[FastAPI\n80 Endpoints · /completions · SSE Streaming]

        subgraph Orchestration ["Orchestration Layer"]
            direction TB
            Supervisor[Supervisor Agent\nPlanning · Delegation]
            Worker[Research Worker\nWeb Search · Verification]
            Scratchpad[(Shared Scratchpad\nread · append · update)]
        end

        subgraph Tools ["Integrated Tools"]
            direction LR
            WebTools[Web Browsing\nread · scroll · search]
            CodeExec[Code Interpreter\nSandbox Execution]
            FileSearch[File Search\nVector Retrieval]
            Computer[Computer Use\nShell · Browser]
        end

        subgraph Storage ["Storage Layer"]
            direction LR
            MySQL[("MySQL\nPersistence")]
            Qdrant[("Qdrant\nVector Store")]
            Redis[("Redis\nStreaming · Cache")]
        end

        subgraph Observability ["Observability"]
            direction LR
            OTEL[OpenTelemetry\nCollector]
            Jaeger[Jaeger UI\nTrace Explorer]
        end
    end

    subgraph Consumers ["Reference Implementations"]
        direction LR
        RefFE[reference-frontend\nReact]
        RefBE[reference-backend\nFlask]
    end

    Developer --> |"pip install projectdavid"| EntityClient
    EntityClient --> Common
    EntityClient --> |"HTTPS / SSE"| FastAPI
    SyncStream --> |"stream_events"| FastAPI

    Proxy --> FastAPI
    ACME --> Proxy
    Proxy --> Landing
    Proxy --> Docs

    FastAPI --> Supervisor
    Supervisor --> |"delegates task"| Worker
    Supervisor --> Scratchpad
    Worker --> Scratchpad
    Worker --> WebTools
    Worker --> FileSearch
    Supervisor --> |"writes strategy"| Scratchpad

    FastAPI --> CodeExec
    FastAPI --> Computer
    FastAPI --> MySQL
    FastAPI --> Qdrant
    FastAPI --> Redis
    FastAPI --> OTEL
    OTEL --> Jaeger

    SDK --> RefBE
    RefBE --> RefFE

    classDef main fill:#dbeafe,stroke:#3b82f6,stroke-width:1.5px,color:#1e3a5f
    classDef worker fill:#fef3c7,stroke:#f59e0b,stroke-width:1.5px,color:#78350f
    classDef external fill:#dcfce7,stroke:#22c55e,stroke-width:1.5px,color:#14532d
    classDef bridge fill:#ede9fe,stroke:#7c3aed,stroke-width:1.5px,color:#4c1d95
    classDef storage fill:#f0fdf4,stroke:#86efac,stroke-width:1.5px,color:#14532d

    class FastAPI,Proxy,ACME main
    class Supervisor,Worker,Scratchpad worker
    class EntityClient,SyncStream,Common bridge
    class MySQL,Qdrant,Redis storage
    class WebTools,CodeExec,FileSearch,Computer external
    class Developer,RefFE,RefBE external

    style DavidCore fill:#eff6ff,stroke:#93c5fd,color:#1e3a5f
    style SDK fill:#f5f3ff,stroke:#a78bfa,color:#4c1d95
    style Platform fill:#fffbeb,stroke:#fcd34d,color:#78350f
    style Orchestration fill:#fef9ee,stroke:#fbbf24,color:#78350f
    style Tools fill:#fef9ee,stroke:#fbbf24,color:#78350f
    style Storage fill:#f0fdf4,stroke:#86efac,color:#14532d
    style Observability fill:#f0fdf4,stroke:#86efac,color:#14532d
    style Consumers fill:#eff6ff,stroke:#93c5fd,color:#1e3a5f